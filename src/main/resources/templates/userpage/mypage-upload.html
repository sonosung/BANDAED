<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>회원정보 수정</title>
    <link th:href="@{/css/login.css}" rel="stylesheet">
    <!-- Google 폰트 로드임 -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --white: #ffffff;
            --gray: #333333;
            --blue: #0367a6;
            --lightblue: #008997;
            --mint: #36f5e2;
            --button-radius: 0.7rem;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
        }
        body {
            background-color: var(--white);
            background: url("https://res.cloudinary.com/dci1eujqw/image/upload/v1616769558/Codepen/waldemar-brandt-aThdSdgx0YM-unsplash_cnq4sb.jpg");
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            padding-top: 100px;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--button-radius);
            box-shadow: 0 0.9rem 1.7rem rgba(0, 0, 0, 0.25), 0 0.7rem 0.7rem rgba(0, 0, 0, 0.22);
            padding: 20px;
            max-width: 54%;
            width: 120%;
            height: 70%;
            display: flex;
            flex-direction: column;
            margin-top: 50px;
            margin-left: 0cm;
        }
        .content-main {
            display: flex;
            flex-direction: column;
            align-items: right;
            position: relative;
        }
        .logo {
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .logo img {
            width: 100px;
            height: auto;
        }
        .logo img:hover {
            filter: brightness(0.8);
        }
        .logo a {
            color: var(--mint);
        }
        .content-mypage-text {
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
            width: 100%;
        }
        .row {
            display: flex;
            width: 100%;
        }
        .col-md-4 {
            height: auto;
        }
        .col-md-8 {
            flex: 0 0 65%;
            max-width: 55%;
            margin-left: 1.5cm;
            min-height: 500px;
            height: auto;
        }
        .card {
            background-color: var(--white);
            border: none;
            border-radius: var(--button-radius);
            box-shadow: 0 0.9rem 1.7rem rgba(0, 0, 0, 0.25), 0 0.7rem 0.7rem rgba(0, 0, 0, 0.22);
            padding: 20px;
            margin: 10px;
            width: 100%;
            height: 60%;
        }
        .card-additional {
            margin-top: 30px;
            margin-left: -355px;
            width: 165%;
            height: 40%;
        }
        .d-flex {
            display: flex;
        }
        .flex-column {
            flex-direction: column;
        }
        .align-items-center {
            align-items: center;
        }
        .text-center {
            text-align: center;
        }
        .text-muted {
            color: #6c757d !important;
        }
        .btn {
            background-color: var(--blue);
            background-image: linear-gradient(90deg, var(--blue) 0%, var(--lightblue) 74%);
            border-radius: 20px;
            border: 1px solid var(--blue);
            color: var(--white);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 0.1rem;
            padding: 0.7rem 1rem;
            text-transform: uppercase;
            transition: transform 80ms ease-in;
            margin: 5px;
            max-width: 100px;
            text-align: center;
            text-decoration: none;
        }
        .btn:hover {
            background-color: var(--lightblue);
        }
        .btn:active {
            transform: scale(0.95);
        }
        .btn:focus {
            outline: none;
        }
        .mb-0 {
            margin-bottom: 1rem !important;
            margin-top: 1rem !important;
            margin-right: 1rem !important;
        }
        .mt-3 {
            margin-top: 0rem !important;
        }
        .text-secondary {
            color: #6c757d !important;
        }
        .row > .col-sm-3 {
            text-align: right;
            padding-right: 10px;
        }
        .row > .col-sm-9 {
            text-align: left;
            padding-left: 10px;
        }
        .col-sm-9 {
            font-size: 0.7rem;
        }
        hr {
            border-top: 1px solid #e9ecef;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            align-items: center;
            justify-items: start;
        }
        .checkbox-grid label {
            display: flex;
            align-items: center;
        }
        .checkbox-grid input[type="checkbox"] {
            margin-right: 5px;
        }
        .large-text {
            font-size: 1.0rem;
        }
        .centered-buttons {
            display: flex;
            justify-content: center;
        }
        .content-row {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
<a th:href="@{/midea/index}" class="logo">
    <img th:src="@{/wooxtravel/assets/images/MIDEA.png}" alt="">
</a>
<div class="container">
    <div class="content-main">
        <div class="content-mypage-text">
            Modify My Page
        </div>
        <form th:action="@{/midea/mypage-upload}" method="post" enctype="multipart/form-data" th:object="${myPageUploadDTO}" id="updateForm">
            <div class="row gutters-sm">
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-column align-items-center text-center">
                                <img th:src="@{${myPageUploadDTO.profileImagePath}}" class="rounded-circle" width="150" height="150" alt="Profile Picture">
                                <div class="mt-3">
                                    <input type="file" name="profileImage" accept="image/*">
                                    <h4 th:text="${myPageUploadDTO.nickname}">Username</h4>
                                    <p class="text-muted font-size-sm">Welcome message</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card card mb-3">
                        <div class="card-body">
                            <div class="content-row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0 large-text">Nickname</h6>
                                </div>
                                <div class="col-sm-9 text-secondary large-text">
                                    <input type="text" th:field="*{nickname}" class="form-control" oninput="validateNickname(this)">
                                    <div id="nicknameError" style="color: red; font-size: 12px;"></div>
                                </div>
                            </div>
                            <hr>
                            <div class="content-row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0 large-text">Email</h6>
                                </div>
                                <div class="col-sm-9 text-secondary large-text">
                                    <input type="email" th:field="*{email}" class="form-control" oninput="validateEmail(this)">
                                    <div id="emailError" style="color: red; font-size: 12px;"></div>
                                </div>
                            </div>
                            <hr>
                            <div class="content-row">
                                <div class="col-sm-12 text-center">
                                    <h6 class="mb-0 large-text">How Do You Feel Today?</h6>
                                </div>
                            </div>
                            <div class="content-row">
                                <div class="checkbox-grid col-sm-12">
                                    <label>
                                        <input type="checkbox" th:field="*{happy}">Happy
                                    </label>
                                    <label>
                                        <input type="checkbox" th:field="*{sad}">Sad
                                    </label>
                                    <label>
                                        <input type="checkbox" th:field="*{calm}">Calm
                                    </label>
                                    <label>
                                        <input type="checkbox" th:field="*{stressed}">Stressed
                                    </label>
                                    <label>
                                        <input type="checkbox" th:field="*{joyful}">Joyful
                                    </label>
                                    <label>
                                        <input type="checkbox" th:field="*{energetic}">Energetic
                                    </label>
                                </div>
                            </div>
                            <hr>
                            <div class="centered-buttons">
                                <button type="submit" class="btn" onclick="showSuccessMessage()">수정완료</button>
                                <a class="btn" href="javascript:void(0);" onclick="confirmCancel()">수정취소</a>
                            </div>
                        </div>
                    </div>

                    <!-- 추가된 카드 리스트 -->
                    <div class="card card-additional">
                        <div class="card-body">
                            <h5 class="card-title">Additional Information</h5>
                            <p class="card-text">This is an additional card with more information.</p>
                        </div>
                    </div>
                    <!-- 추가된 카드 리스트 끝 -->
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function checkNicknameAvailability(nickname, callback) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `/midea/check-nickname?nickname=${encodeURIComponent(nickname)}`, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    callback(xhr.responseText === 'true');
                } else {
                    console.error("Error checking nickname availability:", xhr.status, xhr.statusText);
                    callback(false);  // 오류 시에도 중복이 아닌 것으로 처리
                }
            }
        };
        xhr.send();
    }

    function checkEmailAvailability(email, callback) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `/midea/check-email?email=${encodeURIComponent(email)}`, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    callback(xhr.responseText === 'true');
                } else {
                    console.error("Error checking email availability:", xhr.status, xhr.statusText);
                    callback(false);  // 오류 시에도 중복이 아닌 것으로 처리
                }
            }
        };
        xhr.send();
    }

    function validateNickname(input) {
        const nicknameError = document.getElementById("nicknameError");
        nicknameError.textContent = ""; // 초기화

        if (input.value.trim() === "") {
            nicknameError.textContent = "닉네임을 적어주세요.";
        } else {
            checkNicknameAvailability(input.value.trim(), function(isDuplicate) {
                if (isDuplicate) {
                    nicknameError.textContent = "닉네임이 이미 존재합니다.";
                } else {
                    nicknameError.textContent = ""; // 중복이 없으면 에러 메시지 제거
                }
            });
        }
    }

    function validateEmail(input) {
        const emailError = document.getElementById("emailError");
        emailError.textContent = ""; // 초기화

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (input.value.trim() === "") {
            emailError.textContent = "이메일을 적어주세요.";
        } else if (!emailPattern.test(input.value.trim())) {
            emailError.textContent = "이메일 형식에 맞지 않습니다.";
        } else {
            checkEmailAvailability(input.value.trim(), function(isDuplicate) {
                if (isDuplicate) {
                    emailError.textContent = "이메일이 이미 존재합니다.";
                } else {
                    emailError.textContent = ""; // 중복이 없으면 에러 메시지 제거
                }
            });
        }
    }

function showSuccessMessage() {
        alert('회원정보 수정 완료했습니다');
        window.location.href = '/midea/mypage';
    }

    function confirmCancel() {
        if (confirm("정말로 수정을 취소하시겠습니까?")) {
            window.location.href = '/midea/mypage';
        }
    }
</script>
</body>
</html>